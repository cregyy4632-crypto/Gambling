<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack - Epic Gambling By IC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a4d2e, #0f6b3a, #1a7a47);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem 2rem;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #ffd700;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-menu a:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: radial-gradient(ellipse at center, #0f4c3a 0%, #0a3d2a 100%);
        }

        .casino-table {
            width: 100%;
            max-width: 1000px;
            background: linear-gradient(135deg, #0d5d2a, #0f6b3a);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 
                0 0 50px rgba(0, 0, 0, 0.5),
                inset 0 0 50px rgba(255, 255, 255, 0.1);
            border: 8px solid #8b4513;
            position: relative;
            overflow: hidden;
        }

        .casino-table::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        .table-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .table-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 10px;
        }

        .table-subtitle {
            font-size: 1.2rem;
            color: #e0e0e0;
            opacity: 0.9;
        }

        .balance-display {
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 2px 2px 0 #000;
        }

        h1 {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .betting-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .betting-circle {
            width: 120px;
            height: 120px;
            border: 4px dashed #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
            margin: 0 20px;
        }

        .bet-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 0 #000;
        }

        .chips-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chip {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .chip:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .chip-1 { background: #ff6b6b; color: white; }
        .chip-5 { background: #4ecdc4; color: white; }
        .chip-10 { background: #45b7d1; color: white; }
        .chip-25 { background: #f9ca24; color: #333; }
        .chip-50 { background: #6c5ce7; color: white; }
        .chip-100 { background: #a29bfe; color: white; }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .dealer-area {
            text-align: center;
            margin-bottom: 20px;
        }

        .player-area {
            text-align: center;
        }

        .hand-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .hand-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .cards-display {
            font-size: 2.5rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: white;
            color: #333;
            padding: 12px 8px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 0, 0, 0.1);
            width: 70px;
            height: 100px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border: 1px solid #ccc;
            transition: all 0.3s ease;
            margin: 0 5px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card.red {
            color: #e74c3c;
        }
        
        .card.black {
            color: #2c3e50;
        }
        
        .card-top {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: left;
        }
        
        .card-center {
            font-size: 2rem;
            margin: 10px 0;
        }
        
        .card-bottom {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: right;
            transform: rotate(180deg);
        }
        
        .card-back {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .hand-value {
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffa726, #ff9800);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .game-status {
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 30px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .game-status.win {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }
        
        .game-status.lose {
            color: #f44336;
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
        }
        
        .game-status.tie {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffd700;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">🎰 Epic Gambling By IC</div>
            <ul class="nav-menu">
                <li><a href="/">Home</a></li>
                <li><a href="/blackjack">Games</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="casino-table">
            <div class="table-header">
                <div class="table-title">🃏 Blackjack</div>
                <div class="table-subtitle">Beat the dealer to 21!</div>
                <div class="balance-display">Balance: $<span id="balance">1000</span></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>

            <div id="error-message" class="error" style="display: none;"></div>
            <div id="success-message" class="success" style="display: none;"></div>

            <!-- Game Status -->
            <div class="game-status" id="game-status">Place your bet and click Deal!</div>

            <!-- Game Area -->
            <div class="game-area">
                <!-- Dealer Area -->
                <div class="dealer-area">
                    <div class="hand-title">Dealer</div>
                    <div class="cards-display" id="dealer-cards">No cards</div>
                    <div class="hand-value" id="dealer-value">Value: 0</div>
                </div>

                <!-- Player Area -->
                <div class="player-area">
                    <div class="hand-title">You</div>
                    <div class="cards-display" id="player-cards">No cards</div>
                    <div class="hand-value" id="player-value">Value: 0</div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="controls">
                <button id="deal-btn" class="btn-primary" onclick="dealCards()">Deal</button>
                <button id="hit-btn" class="btn-secondary" onclick="hit()" disabled>Hit</button>
                <button id="stand-btn" class="btn-warning" onclick="stand()" disabled>Stand</button>
                <button id="double-btn" class="btn-primary" onclick="doubleDown()" disabled>Double</button>
                <button id="new-game-btn" class="btn-primary" onclick="startNewGame()">New Game</button>
            </div>

            <!-- Betting Area (Moved to Bottom) -->
            <div class="betting-area">
                <div class="betting-circle">
                    <div class="bet-amount" id="bet-amount">$0</div>
                </div>
            </div>

            <!-- Chips -->
            <div class="chips-container">
                <div class="chip chip-1" onclick="addBet(1)">$1</div>
                <div class="chip chip-5" onclick="addBet(5)">$5</div>
                <div class="chip chip-10" onclick="addBet(10)">$10</div>
                <div class="chip chip-25" onclick="addBet(25)">$25</div>
                <div class="chip chip-50" onclick="addBet(50)">$50</div>
                <div class="chip chip-100" onclick="addBet(100)">$100</div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '/api/blackjack';
        let gameState = null;
        let currentBet = 0;
        let playerBalance = 1000; // Default balance

        // Get balance from URL parameter
        function getBalanceFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const balance = urlParams.get('balance');
            return balance ? parseInt(balance) : 1000;
        }

        // Initialize balance
        playerBalance = getBalanceFromURL();

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function updateGameDisplay(state) {
            gameState = state;
            
            // Update dealer cards
            const dealerCards = document.getElementById('dealer-cards');
            const dealerValue = document.getElementById('dealer-value');
            
            if (state.dealerCards && state.dealerCards.length > 0) {
                dealerCards.innerHTML = state.dealerCards.map((card, index) => {
                    // Hide dealer's first card during gameplay
                    if (index === 0 && !state.roundOver && state.gameStarted) {
                        return `<div class="card card-back">🂠</div>`;
                    }
                    return createCardElement(card);
                }).join('');
                dealerValue.textContent = `Value: ${state.dealerValue}`;
            } else {
                dealerCards.textContent = 'No cards';
                dealerValue.textContent = 'Value: 0';
            }

            // Update player cards
            const playerCards = document.getElementById('player-cards');
            const playerValue = document.getElementById('player-value');
            
            if (state.playerCards && state.playerCards.length > 0) {
                playerCards.innerHTML = state.playerCards.map(card => createCardElement(card)).join('');
                playerValue.textContent = `Value: ${state.playerValue}`;
            } else {
                playerCards.textContent = 'No cards';
                playerValue.textContent = 'Value: 0';
            }

            // Update game status
            const statusDiv = document.getElementById('game-status');
            if (state.gameResult) {
                statusDiv.textContent = state.gameResult;
                statusDiv.className = 'game-status ' + (state.gameResult.includes('win') ? 'win' : 
                    state.gameResult.includes('lose') ? 'lose' : 'tie');
                
                // Update balance based on result
                if (state.gameResult.includes('win') || state.gameResult.includes('Player wins')) {
                    playerBalance += currentBet * 2; // Win pays 1:1
                } else if (state.gameResult.includes('lose') || state.gameResult.includes('Dealer wins')) {
                    // Balance already deducted when bet was placed
                } else if (state.gameResult.includes('Push') || state.gameResult.includes('tie')) {
                    playerBalance += currentBet; // Return bet for tie
                }
                updateBalance();
                
                // Auto-reset after showing result
                setTimeout(() => {
                    resetGameState();
                }, 3000);
            } else if (state.playerBust) {
                statusDiv.textContent = '💥 You busted! Dealer wins.';
                statusDiv.className = 'game-status lose';
                // Balance already deducted when bet was placed
                setTimeout(() => {
                    resetGameState();
                }, 3000);
            } else if (state.dealerBust) {
                statusDiv.textContent = '🎉 Dealer busted! You win!';
                statusDiv.className = 'game-status win';
                playerBalance += currentBet * 2; // Win pays 1:1
                updateBalance();
                setTimeout(() => {
                    resetGameState();
                }, 3000);
            } else if (state.roundOver) {
                statusDiv.textContent = 'Round over. Place a new bet and click Deal to play again!';
                statusDiv.className = 'game-status';
                // Auto-reset the game state for next round
                setTimeout(() => {
                    resetGameState();
                }, 2000);
            } else if (state.gameStarted) {
                statusDiv.textContent = '🎯 Game in progress. Make your move!';
                statusDiv.className = 'game-status';
            } else {
                statusDiv.textContent = '🎰 Place your bet and click Deal!';
                statusDiv.className = 'game-status';
            }

            // Update button states
            updateButtonStates();
        }

        async function makeApiCall(endpoint, method = 'GET') {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    if (data.data) {
                        updateGameDisplay(data.data);
                    }
                    if (data.message) {
                        showSuccess(data.message);
                    }
                } else {
                    showError(data.message || 'An error occurred');
                }
            } catch (error) {
                hideLoading();
                showError('Network error: ' + error.message);
            }
        }

        function addBet(amount) {
            console.log('Adding bet:', amount, 'Current bet:', currentBet, 'Balance:', playerBalance);
            if (currentBet + amount <= playerBalance) {
                currentBet += amount;
                updateBetDisplay();
                updateButtonStates(); // Update button states when bet is placed
                console.log('Bet added, new currentBet:', currentBet);
            } else {
                showError('Insufficient balance!');
            }
        }

        function updateBetDisplay() {
            document.getElementById('bet-amount').textContent = '$' + currentBet;
        }

        function updateBalance() {
            document.getElementById('balance').textContent = playerBalance;
        }

        function updateButtonStates() {
            const dealBtn = document.getElementById('deal-btn');
            const hitBtn = document.getElementById('hit-btn');
            const standBtn = document.getElementById('stand-btn');
            const doubleBtn = document.getElementById('double-btn');
            const newGameBtn = document.getElementById('new-game-btn');

            if (gameState && gameState.gameStarted && !gameState.roundOver) {
                // Game in progress
                dealBtn.disabled = true;
                hitBtn.disabled = false;
                standBtn.disabled = false;
                doubleBtn.disabled = false;
                newGameBtn.disabled = true;
            } else if (gameState && gameState.gameStarted && gameState.roundOver) {
                // Round over - disable all buttons, will auto-reset
                dealBtn.disabled = true;
                hitBtn.disabled = true;
                standBtn.disabled = true;
                doubleBtn.disabled = true;
                newGameBtn.disabled = true;
            } else {
                // No game started - enable deal if bet is placed
                dealBtn.disabled = currentBet === 0;
                hitBtn.disabled = true;
                standBtn.disabled = true;
                doubleBtn.disabled = true;
                newGameBtn.disabled = false;
            }
        }

        function clearBet() {
            currentBet = 0;
            updateBetDisplay();
            updateButtonStates();
        }

        async function dealCards() {
            console.log('Deal button clicked, currentBet:', currentBet);
            if (currentBet === 0) {
                showError('Please place a bet first!');
                return;
            }
            // Deduct bet from balance
            playerBalance -= currentBet;
            updateBalance();
            await makeApiCall('/start', 'POST');
        }

        async function startNewGame() {
            clearBet();
            await makeApiCall('/reset', 'POST');
        }

        function doubleDown() {
            if (currentBet * 2 <= playerBalance) {
                currentBet *= 2;
                updateBetDisplay();
                hit();
            } else {
                showError('Insufficient balance to double down!');
            }
        }

        async function hit() {
            await makeApiCall('/hit', 'POST');
        }

        async function stand() {
            await makeApiCall('/stand', 'POST');
        }

        async function resetGame() {
            await makeApiCall('/reset', 'POST');
        }

        function resetGameState() {
            // Reset the frontend game state without API call
            gameState = null;
            currentBet = 0;
            updateBetDisplay();
            updateButtonStates();
            
            // Clear the card displays
            document.getElementById('player-cards').innerHTML = '';
            document.getElementById('dealer-cards').innerHTML = '';
            document.getElementById('player-value').textContent = 'Value: 0';
            document.getElementById('dealer-value').textContent = 'Value: 0';
            
            // Update status
            document.getElementById('game-status').textContent = '🎰 Place your bet and click Deal!';
            document.getElementById('game-status').className = 'game-status';
        }

        function createCardElement(card) {
            // Ensure we have the card data
            if (!card) {
                console.log('No card data provided');
                return `<div class="card">?</div>`;
            }
            
            console.log('Creating card element:', card);
            
            const isRed = card.isRed || (card.suit === 'HEARTS' || card.suit === 'DIAMONDS');
            const suitSymbol = card.suitSymbol || getSuitSymbol(card.suit);
            const rankSymbol = card.rankSymbol || getRankSymbol(card.rank);
            
            console.log('Card symbols - Suit:', suitSymbol, 'Rank:', rankSymbol, 'isRed:', isRed);
            
            return `
                <div class="card ${isRed ? 'red' : 'black'}">
                    <div class="card-top">${rankSymbol}</div>
                    <div class="card-center">${suitSymbol}</div>
                    <div class="card-bottom">${rankSymbol}</div>
                </div>
            `;
        }
        
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'HEARTS': return '♥';
                case 'DIAMONDS': return '♦';
                case 'CLUBS': return '♣';
                case 'SPADES': return '♠';
                default: return '?';
            }
        }
        
        function getRankSymbol(rank) {
            switch(rank) {
                case 'TWO': return '2';
                case 'THREE': return '3';
                case 'FOUR': return '4';
                case 'FIVE': return '5';
                case 'SIX': return '6';
                case 'SEVEN': return '7';
                case 'EIGHT': return '8';
                case 'NINE': return '9';
                case 'TEN': return '10';
                case 'JACK': return 'J';
                case 'QUEEN': return 'Q';
                case 'KING': return 'K';
                case 'ACE': return 'A';
                default: return '?';
            }
        }

        // Load initial game state
        window.onload = function() {
            updateBalance();
            updateButtonStates();
            makeApiCall('/state');
        };
    </script>
</body>
</html>



