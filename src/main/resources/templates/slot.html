<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishing Frenzy Slot Machine - Epic Gambling By IC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .navbar {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 150, 0.2);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 150, 0.3);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        .nav-item a {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-item a:hover {
            background: rgba(0, 255, 150, 0.1);
            color: #00ff96;
            transform: translateY(-2px);
        }

        .nav-item a.active {
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            color: #000;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00ff96;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            height: fit-content;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ffffff;
            text-decoration: none;
        }

        .sidebar-item:hover {
            background: rgba(0, 255, 150, 0.1);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            color: #000;
            font-weight: 600;
        }

        .game-area {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #00ff96, #00d4aa, #ff6b9d);
        }

        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            text-shadow: 0 0 40px rgba(0, 255, 150, 0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #00ff96;
        }

        .bet-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6b9d;
        }

        .slot-machine {
            background: linear-gradient(145deg, #0f1419, #1a1f2e);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid rgba(0, 255, 150, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .reels-container {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 0.5rem;
        }

        @media (max-width: 768px) {
            .reels-container {
                gap: 0.3rem;
                margin: 0.5rem 0;
                padding: 0.3rem;
            }
            
            .reel {
                min-width: 60px;
                max-width: 60px;
            }
            
            .reel-symbol {
                font-size: 2rem;
                min-width: 50px;
                min-height: 50px;
            }
        }

        .reel {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 3px solid rgba(0, 255, 150, 0.3);
            border-radius: 15px;
            padding: 1rem;
            min-width: 80px;
            max-width: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transform-style: preserve-3d;
            perspective: 1000px;
            overflow: hidden;
            position: relative;
        }

        .reel-symbol {
            font-size: 3rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 80px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .spinning .reel-symbol {
            animation: slotSpin 0.1s linear infinite;
            transform-style: preserve-3d;
        }

        @keyframes slotSpin {
            0% { 
                transform: translateY(0px) rotateX(0deg);
                opacity: 1;
            }
            25% { 
                transform: translateY(-20px) rotateX(90deg);
                opacity: 0.7;
            }
            50% { 
                transform: translateY(-40px) rotateX(180deg);
                opacity: 0.5;
            }
            75% { 
                transform: translateY(-20px) rotateX(270deg);
                opacity: 0.7;
            }
            100% { 
                transform: translateY(0px) rotateX(360deg);
                opacity: 1;
            }
        }

        .reel-symbol.winning {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: pulse 1s infinite;
        }

        .game-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-bet {
            background: linear-gradient(45deg, #44a08d, #093637);
            color: white;
        }

        .btn-bet:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(68, 160, 141, 0.4);
        }

        .btn-spin {
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            color: #000;
            font-size: 1.2rem;
            padding: 1rem 2rem;
            box-shadow: 0 4px 15px rgba(0, 255, 150, 0.3);
        }

        .btn-spin:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 150, 0.4);
        }

        .btn-auto {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .btn-auto:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .btn-auto.active {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            animation: pulse 1s infinite;
        }

        .betting-area {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 2rem 0;
        }

        .betting-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #00ff96;
            text-align: center;
        }

        .chip-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .chip {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .chip:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .chip-5 { background: linear-gradient(45deg, #ff6b9d, #ff8fab); color: white; }
        .chip-10 { background: linear-gradient(45deg, #00d4aa, #00ff96); color: white; }
        .chip-25 { background: linear-gradient(45deg, #ffa502, #ffb142); color: black; }
        .chip-50 { background: linear-gradient(45deg, #ff4757, #ff6b7a); color: white; }
        .chip-100 { background: linear-gradient(45deg, #9c88ff, #a29bfe); color: white; }
        .chip-500 { background: linear-gradient(45deg, #ffd700, #ffed4e); color: black; }

        .game-status {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-status.win {
            background: linear-gradient(45deg, #00ff96, #00d4aa);
            color: #000;
            animation: pulse 1s infinite;
        }

        .game-status.lose {
            background: linear-gradient(45deg, #ff4757, #ff6b7a);
            color: #fff;
        }

        .error {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
        }

        .success {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
        }

        .free-spins-display {
            background: linear-gradient(45deg, #ff6b9d, #ff8fab);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .paytable {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .paytable h3 {
            color: #00ff96;
            margin-bottom: 1rem;
            text-align: center;
        }

        .paytable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .paytable-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .symbol {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .payout {
            color: #00ff96;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .sidebar {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .game-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .chip-container {
                gap: 0.5rem;
            }
            
            .chip {
                width: 50px;
                height: 50px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">EPIC GAMBLING</div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/">Dashboard</a></li>
                <li class="nav-item"><a href="/blackjack">Blackjack</a></li>
                <li class="nav-item"><a href="/slot" class="active">Slots</a></li>
                <li class="nav-item"><a href="#">Live Support</a></li>
            </ul>
            <div class="user-info">
                <div class="balance">Balance: $<span id="user-balance">1000</span></div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar">
            <a href="/" class="sidebar-item">
                <span class="sidebar-icon">🏠</span>
                <span>Dashboard</span>
            </a>
            <a href="/blackjack" class="sidebar-item">
                <span class="sidebar-icon">🃏</span>
                <span>Blackjack</span>
            </a>
            <a href="/slot" class="sidebar-item active">
                <span class="sidebar-icon">🎰</span>
                <span>Slots</span>
            </a>
            <a href="#" class="sidebar-item">
                <span class="sidebar-icon">🎲</span>
                <span>Dice</span>
            </a>
            <a href="#" class="sidebar-item">
                <span class="sidebar-icon">🎯</span>
                <span>Roulette</span>
            </a>
            <a href="#" class="sidebar-item">
                <span class="sidebar-icon">💬</span>
                <span>Live Support</span>
            </a>
        </div>

        <div class="game-area">
            <h1 class="game-title">Fishing Frenzy Slots</h1>
            
            <div class="game-info">
                <div class="balance-display">Balance: $<span id="balance">1000</span></div>
                <div class="bet-display">Bet: $<span id="bet-amount">0</span></div>
            </div>

            <div class="slot-machine">
                <div class="reels-container">
                    <div class="reel" id="reel1">
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                    </div>
                    <div class="reel" id="reel2">
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                    </div>
                    <div class="reel" id="reel3">
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                    </div>
                    <div class="reel" id="reel4">
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                    </div>
                    <div class="reel" id="reel5">
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                        <div class="reel-symbol">🎰</div>
                    </div>
                </div>

                <div class="game-buttons">
                    <button class="btn btn-bet" onclick="clearBet()">Clear Bet</button>
                    <button class="btn btn-spin" id="spin-btn" onclick="spin()" disabled>🎣 SPIN</button>
                    <button class="btn btn-auto" id="auto-spin-btn" onclick="toggleAutoSpin()" disabled>🔄 AUTO SPIN</button>
                </div>
            </div>

            <div class="game-status" id="game-status">
                🎰 Place your bet and click SPIN to start fishing!
            </div>

            <div class="free-spins-display" id="free-spins-display">
                🎉 FREE SPINS: <span id="free-spins-count">0</span> remaining!
            </div>

            <div class="betting-area">
                <div class="betting-title">Place Your Bet</div>
                <div class="chip-container">
                    <div class="chip chip-5" onclick="addBet(5)">$5</div>
                    <div class="chip chip-10" onclick="addBet(10)">$10</div>
                    <div class="chip chip-25" onclick="addBet(25)">$25</div>
                    <div class="chip chip-50" onclick="addBet(50)">$50</div>
                    <div class="chip chip-100" onclick="addBet(100)">$100</div>
                    <div class="chip chip-500" onclick="addBet(500)">$500</div>
                </div>
            </div>

            <div class="paytable">
                <h3>🎣 Paytable - Fishing Frenzy (5 Reels)</h3>
                <div class="paytable-grid">
                    <div class="paytable-item">
                        <div class="symbol">🐟🐟🐟🐟🐟</div>
                        <div class="payout">1000x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">🦈🦈🦈🦈</div>
                        <div class="payout">500x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">🐠🐠🐠</div>
                        <div class="payout">100x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">🦑🦑</div>
                        <div class="payout">25x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">🦀</div>
                        <div class="payout">5x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">⭐</div>
                        <div class="payout">10x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">💎</div>
                        <div class="payout">50x</div>
                    </div>
                    <div class="paytable-item">
                        <div class="symbol">🎰🎰🎰</div>
                        <div class="payout">10 FREE SPINS</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = null;
        let playerBalance = 1000;
        let currentBet = 0;
        let autoSpinActive = false;
        let autoSpinInterval = null;

        // Get balance from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const balanceParam = urlParams.get('balance');
        if (balanceParam) {
            playerBalance = parseInt(balanceParam);
        }

        async function makeApiCall(endpoint, method = 'GET', data = null) {
            try {
                console.log('Making API call to:', `/slot${endpoint}`, 'Method:', method);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`/slot${endpoint}`, options);
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.success) {
                    gameState = result.data;
                    updateGameDisplay();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('API Error:', error);
                showError('Network error: ' + error.message);
            } finally {
                hideSpinningAnimation();
                updateButtonStates();
            }
        }

        function updateGameDisplay() {
            if (!gameState) return;

            // Update balance from backend
            if (gameState.playerBalance !== undefined) {
                playerBalance = gameState.playerBalance;
                updateBalanceDisplay();
            }
            
            if (gameState.currentBet !== undefined) {
                currentBet = gameState.currentBet;
                updateBetDisplay();
            }

            // Update free spins display
            const freeSpinsDisplay = document.getElementById('free-spins-display');
            const freeSpinsCount = document.getElementById('free-spins-count');
            if (gameState.freeSpinsRemaining > 0) {
                freeSpinsDisplay.style.display = 'inline-block';
                freeSpinsCount.textContent = gameState.freeSpinsRemaining;
            } else {
                freeSpinsDisplay.style.display = 'none';
            }

            // Update reels
            updateReels();

            // Update status
            const statusDiv = document.getElementById('game-status');
            statusDiv.textContent = gameState.message || '🎰 Place your bet and click SPIN!';
            statusDiv.className = 'game-status';
            
            if (gameState.message && gameState.message.includes('win')) {
                statusDiv.className += ' win';
            } else if (gameState.message && gameState.message.includes('lose')) {
                statusDiv.className += ' lose';
            }
        }

        function updateReels() {
            if (!gameState) return;

            const reels = [gameState.reel1, gameState.reel2, gameState.reel3, gameState.reel4, gameState.reel5];
            
            for (let i = 0; i < 5; i++) {
                const reelElement = document.getElementById(`reel${i + 1}`);
                const symbols = reelElement.querySelectorAll('.reel-symbol');
                
                if (reels[i] && reels[i].length > 0) {
                    reels[i].forEach((symbol, index) => {
                        if (symbols[index]) {
                            symbols[index].textContent = symbol;
                        }
                    });
                }
            }

            // Check for winning combinations
            if (gameState.winningPositions) {
                checkWinningCombinations(gameState.winningPositions);
            }
        }

        function checkWinningCombinations(positions) {
            for (let i = 0; i < positions.length; i++) {
                const reel = document.getElementById(`reel${i + 1}`);
                const symbols = reel.querySelectorAll('.reel-symbol');
                symbols[positions[i]].classList.add('winning');
            }
        }

        function enableSpinButton() {
            const spinBtn = document.getElementById('spin-btn');
            const autoBtn = document.getElementById('auto-spin-btn');
            console.log('Enabling spin button - currentBet:', currentBet);
            
            if (currentBet > 0) {
                spinBtn.disabled = false;
                autoBtn.disabled = false;
                console.log('Spin button enabled');
            }
        }

        function disableSpinButton() {
            const spinBtn = document.getElementById('spin-btn');
            const autoBtn = document.getElementById('auto-spin-btn');
            console.log('Disabling spin button');
            
            spinBtn.disabled = true;
            autoBtn.disabled = true;
        }

        function updateButtonStates() {
            console.log('Updating button states - currentBet:', currentBet, 'gameState:', gameState);
            
            if (currentBet > 0) {
                if (!gameState || !gameState.gameStarted || gameState.roundOver) {
                    enableSpinButton();
                } else {
                    disableSpinButton();
                }
            } else {
                disableSpinButton();
            }
        }

        function resetGameState() {
            // Stop auto-spin if active
            if (autoSpinActive) {
                stopAutoSpin();
            }
            
            // Reset the frontend game state without API call
            gameState = null;
            currentBet = 0;
            updateBetDisplay();
            disableSpinButton();
            
            // Clear the reels
            for (let i = 1; i <= 5; i++) {
                const reelElement = document.getElementById(`reel${i}`);
                const symbols = reelElement.querySelectorAll('.reel-symbol');
                symbols.forEach(symbol => {
                    symbol.textContent = '🎰';
                    symbol.classList.remove('winning');
                });
            }
            
            // Hide free spins display
            document.getElementById('free-spins-display').style.display = 'none';
            
            // Update status
            document.getElementById('game-status').textContent = '🎰 Place your bet and click SPIN!';
            document.getElementById('game-status').className = 'game-status';
            
            console.log('Game state reset');
        }

        function addBet(amount) {
            console.log('Adding bet:', amount, 'Current bet:', currentBet);
            
            // Ensure currentBet is a number
            if (typeof currentBet !== 'number' || isNaN(currentBet)) {
                currentBet = 0;
            }
            
            if (currentBet + amount <= playerBalance) {
                currentBet += amount;
                console.log('Bet added successfully, new currentBet:', currentBet);
                
                updateBetDisplay();
                enableSpinButton();
                
                // Show visual feedback
                const betDisplay = document.getElementById('bet-amount');
                if (betDisplay) {
                    betDisplay.style.backgroundColor = '#4caf50';
                    betDisplay.style.color = 'white';
                    setTimeout(() => {
                        betDisplay.style.backgroundColor = '';
                        betDisplay.style.color = '';
                    }, 500);
                }
                
                showSuccess('Bet placed: $' + currentBet);
            } else {
                showError('Insufficient balance!');
            }
        }

        function updateBetDisplay() {
            document.getElementById('bet-amount').textContent = currentBet;
        }

        function updateBalanceDisplay() {
            document.getElementById('balance').textContent = playerBalance;
            document.getElementById('user-balance').textContent = playerBalance;
        }

        function clearBet() {
            currentBet = 0;
            updateBetDisplay();
            disableSpinButton();
            console.log('Bet cleared');
        }

        async function spin() {
            console.log('Spin button clicked - currentBet:', currentBet);
            
            if (currentBet === 0) {
                showError('Please place a bet first!');
                return;
            }
            
            console.log('Proceeding with spin...');
            
            // Deduct bet from balance immediately
            playerBalance -= currentBet;
            updateBalanceDisplay();
            console.log('Bet deducted, new balance:', playerBalance);
            
            // Disable buttons during spin
            disableSpinButton();
            
            // Show spinning animation
            showSpinningAnimation();
            
            // Change symbols continuously during spin
            const spinInterval = setInterval(() => {
                for (let i = 1; i <= 5; i++) {
                    const reel = document.getElementById(`reel${i}`);
                    if (reel && reel.classList.contains('spinning')) {
                        const symbols = reel.querySelectorAll('.reel-symbol');
                        symbols.forEach(symbol => {
                            symbol.textContent = getRandomSymbol();
                        });
                    }
                }
            }, 100);
            
            try {
                await makeApiCall('/spin', 'POST');
            } catch (error) {
                console.error('Spin error:', error);
                showError('Spin failed!');
                // Refund the bet if spin failed
                playerBalance += currentBet;
                updateBalanceDisplay();
            } finally {
                clearInterval(spinInterval);
            }
        }

        function toggleAutoSpin() {
            if (autoSpinActive) {
                stopAutoSpin();
            } else {
                startAutoSpin();
            }
        }

        function startAutoSpin() {
            if (currentBet === 0) {
                showError('Please place a bet first!');
                return;
            }
            
            if (playerBalance < currentBet) {
                showError('Insufficient balance for auto-spin!');
                return;
            }
            
            autoSpinActive = true;
            const autoBtn = document.getElementById('auto-spin-btn');
            autoBtn.textContent = '⏹️ STOP AUTO';
            autoBtn.classList.add('active');
            
            // Auto spin every 2 seconds
            autoSpinInterval = setInterval(async () => {
                if (autoSpinActive && currentBet > 0 && playerBalance >= currentBet) {
                    // Deduct bet from balance
                    playerBalance -= currentBet;
                    updateBalanceDisplay();
                    
                    // Show spinning animation
                    showSpinningAnimation();
                    
                    // Change symbols continuously during spin
                    const spinInterval = setInterval(() => {
                        for (let i = 1; i <= 5; i++) {
                            const reel = document.getElementById(`reel${i}`);
                            if (reel && reel.classList.contains('spinning')) {
                                const symbols = reel.querySelectorAll('.reel-symbol');
                                symbols.forEach(symbol => {
                                    symbol.textContent = getRandomSymbol();
                                });
                            }
                        }
                    }, 100);
                    
                    try {
                        await makeApiCall('/spin', 'POST');
                    } catch (error) {
                        console.error('Auto spin error:', error);
                        // Refund the bet if spin failed
                        playerBalance += currentBet;
                        updateBalanceDisplay();
                    } finally {
                        clearInterval(spinInterval);
                    }
                } else {
                    stopAutoSpin();
                }
            }, 2000);
            
            console.log('Auto spin started');
        }

        function stopAutoSpin() {
            autoSpinActive = false;
            const autoBtn = document.getElementById('auto-spin-btn');
            autoBtn.textContent = '🔄 AUTO SPIN';
            autoBtn.classList.remove('active');
            
            if (autoSpinInterval) {
                clearInterval(autoSpinInterval);
                autoSpinInterval = null;
            }
            
            console.log('Auto spin stopped');
        }

        function showSpinningAnimation() {
            console.log('Starting spinning animation...');
            
            // Add spinning class to reels
            for (let i = 1; i <= 5; i++) {
                const reel = document.getElementById(`reel${i}`);
                console.log(`Adding spinning class to reel${i}:`, reel);
                if (reel) {
                    reel.classList.add('spinning');
                    console.log(`Reel${i} classes:`, reel.className);
                    
                    // Change symbols during spin for better effect
                    const symbols = reel.querySelectorAll('.reel-symbol');
                    symbols.forEach(symbol => {
                        symbol.textContent = getRandomSymbol();
                    });
                }
            }
            
            // Update status
            document.getElementById('game-status').textContent = '🎰 Spinning...';
            document.getElementById('game-status').className = 'game-status';
            
            console.log('Spinning animation started');
        }

        function getRandomSymbol() {
            const symbols = ['🐟', '🦈', '🐠', '🦑', '🦀', '⭐', '💎', '🎰'];
            return symbols[Math.floor(Math.random() * symbols.length)];
        }

        function hideSpinningAnimation() {
            console.log('Stopping spinning animation...');
            
            // Remove spinning class from reels
            for (let i = 1; i <= 5; i++) {
                const reel = document.getElementById(`reel${i}`);
                console.log(`Removing spinning class from reel${i}:`, reel);
                if (reel) {
                    reel.classList.remove('spinning');
                    console.log(`Reel${i} classes after removal:`, reel.className);
                }
            }
            
            console.log('Spinning animation stopped');
        }

        function showError(message) {
            const statusDiv = document.getElementById('game-status');
            statusDiv.textContent = '❌ ' + message;
            statusDiv.className = 'game-status lose';
        }

        function showSuccess(message) {
            const statusDiv = document.getElementById('game-status');
            statusDiv.textContent = '✅ ' + message;
            statusDiv.className = 'game-status win';
            setTimeout(() => {
                statusDiv.textContent = '🎰 Place your bet and click SPIN!';
                statusDiv.className = 'game-status';
            }, 2000);
        }

        // Load initial game state
        window.onload = function() {
            console.log('Page loaded, initializing slot machine');
            updateBetDisplay();
            updateBalanceDisplay();
            disableSpinButton();
            makeApiCall('/state');
        };
    </script>
</body>
</html>